# Sprint 3: ヤエー・スポット機能

## 📋 スプリント概要
- **期間**: 2-3週間
- **ステータス**: 🔄 準備中
- **主要機能**: ヤエー記録、スポットDB、共有機能

## 🎯 実装目標

### ヤエー記録機能
ツーリング中に他のライダーと遭遇した際の記録・管理機能

### スポットDB機能
二輪駐車場、温泉、ライダー歓迎店などのスポット情報管理

### 共有機能
ルートのURL/QRコード共有機能

---

## 📋 詳細実装項目

### 1. ヤエー記録機能

#### 1.1 GPS近接マッチング
- [ ] **位置追跡サービス実装**
  - バックグラウンド位置追跡
  - 位置情報の精度設定
  - バッテリー最適化
- [ ] **近接検出アルゴリズム**
  - 距離閾値設定（80m）
  - 時間窓設定（±60秒）
  - 速度・方位による信頼度補正
- [ ] **ヤエーイベント記録**
  - イベントデータベース保存
  - 重複検出防止
  - プライバシー保護（位置マスキング）

#### 1.2 ヤエー履歴画面
- [ ] **履歴一覧表示**
  - 時系列でのヤエー記録表示
  - フィルター機能（日付、場所）
  - 検索機能
- [ ] **ヤエー詳細表示**
  - 遭遇場所の地図表示
  - 遭遇時刻・信頼度表示
  - 相手ユーザー情報（匿名化）

#### 1.3 ヤエー統計・プロフィール
- [ ] **統計情報表示**
  - 総ヤエー数
  - 月別・年別統計
  - 人気エリア表示
- [ ] **プロフィール機能**
  - ヤエーランキング
  - フォロー・いいね機能
  - ソーシャル機能

### 2. スポットDB機能

#### 2.1 スポット投稿機能
- [ ] **スポット作成画面**
  - 地図上での位置選択
  - スポット情報入力（名前、説明、タグ）
  - 営業時間設定
  - 写真アップロード
- [ ] **スポット検証機能**
  - 管理者による検証
  - ユーザーレポート機能
  - 品質管理

#### 2.2 スポット一覧・検索
- [ ] **スポット一覧画面**
  - 地図表示・リスト表示切り替え
  - カテゴリ別フィルター
  - 距離順・評価順ソート
- [ ] **スポット検索機能**
  - キーワード検索
  - タグベース検索
  - 位置ベース検索
  - 高度検索（営業時間、評価等）

#### 2.3 スポット詳細・評価
- [ ] **スポット詳細画面**
  - 詳細情報表示
  - 写真ギャラリー
  - 営業時間・アクセス情報
- [ ] **評価・レビュー機能**
  - 星評価システム
  - コメント投稿
  - 写真投稿
  - 役に立った機能

### 3. 共有機能

#### 3.1 URL共有
- [ ] **共有トークン生成**
  - 短縮URL生成
  - 期限設定
  - アクセス権限設定
- [ ] **共有リンク管理**
  - 共有履歴
  - アクセス統計
  - 共有停止機能

#### 3.2 QRコード共有
- [ ] **QRコード生成**
  - ルート情報のQRコード化
  - カスタムデザイン
  - サイズ調整
- [ ] **QRコード表示画面**
  - フルスクリーン表示
  - 保存・共有機能
  - 印刷対応

#### 3.3 深いリンク対応
- [ ] **アプリ内リンク処理**
  - URLスキーム設定
  - ルート詳細への直接遷移
  - 未インストール時の処理
- [ ] **Webプレビュー**
  - ルート情報のWeb表示
  - GPX/KMLダウンロード
  - アプリインストール誘導

---

## 📁 作成予定ファイル

### 画面ファイル
```
lib/screens/
├── yae/
│   ├── yae_history_screen.dart       # ヤエー履歴画面
│   ├── yae_detail_screen.dart        # ヤエー詳細画面
│   ├── yae_profile_screen.dart       # ヤエー統計画面
│   └── yae_settings_screen.dart      # ヤエー設定画面
├── spots/
│   ├── spot_list_screen.dart          # スポット一覧画面
│   ├── spot_detail_screen.dart        # スポット詳細画面
│   ├── spot_creation_screen.dart      # スポット投稿画面
│   └── spot_search_screen.dart       # スポット検索画面
└── share/
    ├── share_screen.dart              # 共有画面
    ├── qr_display_screen.dart         # QRコード表示画面
    └── share_settings_screen.dart     # 共有設定画面
```

### サービスファイル
```
lib/services/
├── yae_service.dart                   # ヤエー処理サービス
├── spot_service.dart                  # スポット処理サービス
├── share_service.dart                 # 共有処理サービス
└── background_location_service.dart   # バックグラウンド位置追跡
```

### プロバイダーファイル
```
lib/providers/
├── yae_provider.dart                  # ヤエー状態管理
├── spot_provider.dart                 # スポット状態管理
└── share_provider.dart                # 共有状態管理
```

### ウィジェットファイル
```
lib/widgets/
├── yae/
│   ├── yae_history_card.dart          # ヤエー履歴カード
│   ├── yae_statistics_widget.dart     # ヤエー統計ウィジェット
│   └── yae_map_marker.dart            # ヤエーマーカー
├── spots/
│   ├── spot_card.dart                 # スポットカード
│   ├── spot_filter_chips.dart        # スポットフィルターチップ
│   └── spot_rating_widget.dart        # スポット評価ウィジェット
└── share/
    ├── qr_code_widget.dart            # QRコードウィジェット
    └── share_options_widget.dart      # 共有オプションウィジェット
```

---

## 🔧 技術要件

### 位置情報・GPS
- **Geolocator**: 位置情報取得
- **Background Location**: バックグラウンド追跡
- **Location Permissions**: 権限管理
- **Battery Optimization**: バッテリー最適化

### QRコード・共有
- **qr_flutter**: QRコード生成
- **share_plus**: システム共有
- **url_launcher**: 深いリンク処理
- **uni_links**: アプリ内リンク処理

### 地図・UI
- **Mapbox GL**: 地図表示
- **Material Design 3**: UIデザイン
- **Riverpod**: 状態管理
- **Cached Network Image**: 画像キャッシュ

### バックエンド連携
- **Dio**: HTTP通信
- **WebSocket**: リアルタイム通信
- **Push Notifications**: プッシュ通知

---

## 📊 実装優先度

### Phase 1 (Week 1-2)
1. **ヤエー記録機能**
   - GPS近接マッチング
   - ヤエー履歴画面
   - 基本的な統計表示

### Phase 2 (Week 2-3)
2. **スポットDB機能**
   - スポット投稿・一覧
   - 検索・フィルター機能
   - 評価システム

### Phase 3 (Week 3-4)
3. **共有機能**
   - URL共有
   - QRコード生成
   - 深いリンク対応

---

## 🧪 テスト計画

### 単体テスト
- [ ] ヤエー検出アルゴリズムテスト
- [ ] スポット検索機能テスト
- [ ] 共有機能テスト

### 統合テスト
- [ ] GPS位置追跡テスト
- [ ] バックエンドAPI連携テスト
- [ ] 深いリンク動作テスト

### UI/UXテスト
- [ ] ヤエー履歴画面テスト
- [ ] スポット一覧画面テスト
- [ ] 共有画面テスト

---

## 📝 メモ・注意事項

### プライバシー考慮
- 位置情報のマスキング
- 匿名化処理
- ユーザー同意の取得

### パフォーマンス考慮
- バックグラウンド処理の最適化
- バッテリー消費の最小化
- メモリ使用量の管理

### セキュリティ考慮
- 位置情報の暗号化
- API通信のセキュリティ
- ユーザーデータの保護
